<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Go wasm sample 3</title>
    <script src="wasm_exec.js"></script>
    <style>
        /* コピーボタンのスタイル */
        .copy-button {
            position: absolute;
            top: 5px;
            left: 5px; /* 右上から左上に変更 */
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .copy-button:hover {
            opacity: 1;
            background-color: #e9ecef;
        }
        /* コピー完了時のスタイル */
        .copy-button.copied {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        /* pre要素のコンテナスタイル */
        .pre-container {
            position: relative;
            margin-bottom: 15px;
        }
        /* レンダリングコントロールのスタイル */
        .render-controls {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .render-controls select {
            margin-right: 10px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .render-controls button {
            padding: 5px 15px;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .render-controls button:hover {
            background-color: #0069d9;
        }
    </style>
</head>

<body>
<script lang="javascript">
    /**
     * @function renderASCII
     * @global
     * @description 入力した Spanner 実行計画をASCIIアートとしてレンダリングします。
     * この関数は 'rendertree.wasm' WebAssembly モジュールによってグローバルに公開され、
     * WebAssembly.instantiateStreaming と go.run() の完了後に利用可能になります。
     * @param {string} input - レンダリングされるテキスト。
     * @returns {string} ASCIIアート表現の文字列。
     */

    const go = new Go();

    function handleFileUpload(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById('input').value = e.target.result;
        };
        reader.readAsText(file);
    }

    WebAssembly.instantiateStreaming(fetch("rendertree.wasm"), go.importObject).then((result) => {
        go.run(result.instance);
    });

    const PREDICATE_MARKER = "*";

    function createTableRow(table, node, index) {
        const { Predicates, ID, TreePart, NodeText } = node;
        const row = table.insertRow(index);
        const idCell = row.insertCell(0);
        const nodeCell = row.insertCell(1);

        idCell.innerText = (Predicates !== null && Predicates.length > 0 ? PREDICATE_MARKER : "") + ID;
        idCell.style.textAlign = "right";

        nodeCell.style.whiteSpace = "pre";
        const codeElement = document.createElement('code');
        codeElement.textContent = TreePart + NodeText;
        nodeCell.appendChild(codeElement);
        return row;
    }

    function table(input) {
        // unmarshal JSON
        const renderedNodes = JSON.parse(input);
        const placeholder = window.document.getElementById("placeholder");
        placeholder.innerHTML = "";

        const table = document.createElement('table');

        renderedNodes.forEach((node, i) => {
            createTableRow(table, node, i);
        });
        placeholder.appendChild(table);
    }

    function copyToClipboard(text) {
        // クリップボードAPIを使用してテキストをコピー
        navigator.clipboard.writeText(text)
            .then(() => {
                console.log('テキストがクリップボードにコピーされました');
                return true;
            })
            .catch(err => {
                console.error('クリップボードへのコピーに失敗しました:', err);
                return false;
            });
    }

    function ascii(input) {
        const result = renderASCII(input)

        const placeholder = window.document.getElementById("placeholder");
        placeholder.innerHTML = "";

        // preコンテナを作成（ポジショニングのため）
        const preContainer = document.createElement('div');
        preContainer.className = 'pre-container';

        // pre要素を作成
        const pre = document.createElement('pre');
        pre.style.fontFamily = "monospace";
        pre.style.whiteSpace = "pre";
        pre.style.border = "solid";
        pre.style.padding = "10px";
        pre.style.marginTop = "0";
        pre.style.position = "relative";

        // コード要素
        const code = document.createElement('code');
        code.innerText = result;
        code.style.fontFamily = "Consolas, 'Courier New', Courier, monospace";

        // コピーボタンを作成
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'コピー';
        
        // コピーボタンのクリックイベントハンドラ
        copyButton.addEventListener('click', function() {
            if (copyToClipboard(code.innerText)) {
                // コピー成功時の視覚的フィードバック
                copyButton.textContent = 'コピー完了!';
                copyButton.classList.add('copied');
                
                // 2秒後に元の状態に戻す
                setTimeout(() => {
                    copyButton.textContent = 'コピー';
                    copyButton.classList.remove('copied');
                }, 2000);
            }
        });

        // 要素を組み立て
        pre.appendChild(code);
        preContainer.appendChild(pre);
        preContainer.appendChild(copyButton);
        placeholder.appendChild(preContainer);
    }

    // 選択されたレンダリング方法に基づいて処理を実行する関数
    function renderSelected() {
        const input = document.getElementById("input").value;
        const renderType = document.getElementById("renderType").value;
        
        if (renderType === "table") {
            table(render(input));
        } else if (renderType === "ascii") {
            ascii(input);
        }
    }

</script>
<label for="fileInput">Upload file:</label>
<input type="file" id="fileInput" onchange="handleFileUpload(event)">
<br><br>
<textarea id="input" rows="10" cols="80"></textarea>
<div class="render-controls">
    <select id="renderType">
        <option value="table">Table</option>
        <option value="ascii">ASCII</option>
    </select>
    <button onClick="renderSelected()">Render</button>
</div>
<div id="placeholder"></div>
</body>
</html>